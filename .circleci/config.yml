version: 2.1

orbs:
  browser-tools: circleci/browser-tools@2.1.2
  mac: circleci/macos@2.5.2
  node: circleci/node@7.1.0
  path-filtering: circleci/path-filtering@1.1.0
  win: circleci/windows@5.1.0

parameters:
  node_version:
    type: string
    default: "22.10.0"
  run-build-test-workflow:
    type: boolean
    default: true

executors:
  linux:
    docker:
      - image: cimg/node:<< pipeline.parameters.node_version >>
        user: root
    resource_class: medium
    environment:
        PUPPETEER_EXECUTABLE_PATH: '/usr/bin/google-chrome-stable'

  macos:
    macos:
      xcode: '16.3.0'
    resource_class: m4pro.medium
    environment:
        PUPPETEER_EXECUTABLE_PATH: '/Applications/Google Chrome.app/Contents/MacOS/Google Chrome'

  playwright:
    docker:
      - image: mcr.microsoft.com/playwright:v1.52.0-noble

  win:
    machine:
      image: 'windows-server-2022-gui:current'
    resource_class: windows.large
    shell: bash.exe # Use bash instead of PowerShell for compatibility with node orb
    environment:
      PUPPETEER_EXECUTABLE_PATH: 'C:\Program Files\Google\Chrome\Application\chrome.exe'
      PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: 'true'

anchors:

  # TODO: Integrate the release version as a variable for use in npm pack
  - &npm_cache_key package-cache-{{ .Branch }}-{{ checksum "package-lock.json" }}-{{ .Environment.CACHE_VERSION }}
  # Chocolatey cache key for Windows installs
  - &choco-cache_key choco-cache-{{ .Branch }}-{{ checksum ".circleci/packages.config" }}-{{ .Environment.CACHE_VERSION }}
  # Chrome/ChromeDriver cache key for Unix systems (Linux/macOS)
  # Note: browser-tools orb prepends "chrome-" and appends chrome version and arch automatically
  - &chrome_cache_key cache-v2-{{ .Branch }}-{{ .Environment.CACHE_VERSION }}

  # nix-specific npm cache paths
  - &npm_cache_paths_unix
    - node_modules
    - packages/*/node_modules
    - ~/.npm
    - ~/.cache

  # Windows-specific npm cache paths
  - &npm_cache_paths_win
    - node_modules
    - packages/*/node_modules
    - C:\Users\circleci\AppData\Local\npm-cache
    - C:\Users\circleci\AppData\Roaming\npm

  - &os_param
    parameters:
      os:
        type: string

  - &matrix_params
    matrix:
      parameters:
        os: [ 'linux', 'macos', 'win' ]
        # TODO: add paremeter for supported node versions

commands:
  install_quire_cli:
    description: "Pack and install the Quire CLI globally"
    steps:
      - run:
          name: Install quire-cli
          # Force execution of npm lifecycle scripts in the foreground
          command: |
            npm pack --workspace packages/cli && \
            npm install thegetty-quire-cli-*.tgz --global --ignore-scripts --foreground-scripts

  build_install_cli-linux:
    steps:
      # Node.js is pre-installed in the cimg/node Docker image
      - browser-tools/install_chrome:
          cache_key: *chrome_cache_key
          use_cache: true
      # TODO: Replace this hack to force-disable the chrome sandbox;
      # On linux chrome, if run as root, requires disabling sandboxing (or using deprecated suid containers)
      # see https://pptr.dev/troubleshooting#setting-up-chrome-linux-sandbox
      - run:
          name: "Modify chrome app"
          command: sudo sed -i 's|HERE/chrome"|HERE/chrome" --no-sandbox|g' /opt/google/chrome/google-chrome
      - browser-tools/install_chromedriver
      - install_quire_cli

  build_install_cli-macos:
    steps:
      # macOS Xcode image includes Node however the version may not be the same
      - node/install:
          node-version: << pipeline.parameters.node_version >>
      - browser-tools/install_chrome:
          cache_key: *chrome_cache_key
          use_cache: true
      - browser-tools/install_chromedriver
      - install_quire_cli

  build_install_cli-win:
    steps:
      - node/install: # Windows image does not include Node.js
          node-version: << pipeline.parameters.node_version >>
      - restore_cache:
          key: *choco-cache_key
      - run:
          name: Install Chocolatey packages
          command: choco install .circleci/packages.config --ignore-checksums
      - save_cache:
          key: *choco-cache_key
          paths:
            - C:\Program Files\Google\Chrome
            - C:\ProgramData\chocolatey\cache
            - C:\tools\selenium
      - install_quire_cli

  install_optional-linux:
    steps:
      - run:
          name: Install optional dependencies
          command: exit 0

  install_optional-macos:
    steps:
      - run:
          name: Install optional dependencies
          command: exit 0

  install_optional-win:
    steps:
      - run:
          name: Install optional dependencies
          command: exit 0

  install_test_dependencies:
    steps:
      - run:
          name: Install test dependencies
          command: npm ci --ignore-scripts --foreground-scripts

  run_tests:
    steps:
      - run:
          name: Set git user identity
          command: |
            git config --global user.email quire@getty.edu
            git config --global user.name "Quire CI"
      - run:
          name: Run end-to-end tests
          no_output_timeout: 30m
          command: mkdir -p reports && npm run test:e2e

      # Persist the site build for browser testing and submit test reports
      - persist_to_workspace:
          root: .
          paths:
            - package.json
            - playwright.config.js
            - reports
            - test-publication-pathname/_site
            - test-publication/_site
            - _tests

      - store_test_results:
          path: reports

      # TODO: Turn this off when we're happy with snapshot coverage of browser tests
      - store_artifacts:
          path: publication.zip

      # Run core package tests - TODO: run these before the e2e tests
      - run:
          name: Run CLI tests
          command: npm run test --workspace packages/cli
      - run:
          name: Run 11ty tests
          command: npm run test --workspace packages/11ty

  test-linux:
    steps:
      - run_tests

  test-macos:
    steps:
      - run_tests

  test-win:
    steps:
      - run_tests

  save_npm_cache-linux:
    steps:
      - save_cache:
          key: *npm_cache_key
          paths: *npm_cache_paths_unix

  save_npm_cache-macos:
    steps:
      - save_cache:
          key: *npm_cache_key
          paths: *npm_cache_paths_unix

  save_npm_cache-win:
    steps:
      - save_cache:
          key: *npm_cache_key
          paths: *npm_cache_paths_win

jobs:
  # Builds the CLI, installs it, and tests it by building a publication
  build_install_test:
    <<: *os_param
    executor: << parameters.os >>
    steps:
      - checkout
      - restore_cache:
          key: *npm_cache_key
      - build_install_cli-<< parameters.os >>
      - install_optional-<< parameters.os >>
      - install_test_dependencies
      - save_npm_cache-<< parameters.os >>
      - test-<< parameters.os >>
  # Tests the output of the publication build -- must be separate for the playwright executor
  browser_test:
    executor: playwright
    # Nota bene: taken from https://playwright.dev/docs/ci#sharding-in-circleci
    parallelism: 4
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Install browser testing dependencies
          command: npm i && apt-get update && apt-get install -y zip && npx playwright install
      # test:browsers-circleci follows https://playwright.dev/docs/ci#circleci to correct sharding
      - run: 
          name: Run browser testing on end-to-end test artifacts
          command: npm run test:browsers-circleci
      - store_test_results:
          path: reports

workflows:
  # Setup workflow - checks if code files changed (excludes all markdown files)
  setup:
    when:
      not: << pipeline.parameters.run-build-test-workflow >>
    jobs:
      - path-filtering/filter:
          base-revision: main
          # Path to configuration file run after path filtering
          # and pipeline parameter value updates are completed.
          config-path: .circleci/config.yml
          # Mapping of path regular expressions to a pipeline parameter value.
          # One mapping per line, 3-column, whitespace-delimited:
          # <path-regex> <pipeline-parameter-name> <pipeline-parameter-value>
          # Pattern matches any file that does not end with .md
          mapping: |
            ^.*(?<!\.md)$ run-build-test-workflow true

  # Main build and test workflow - only runs when code files change
  build_install_test:
    when: << pipeline.parameters.run-build-test-workflow >>
    jobs:
      - build_install_test:
          <<: *matrix_params
          name: build_install_test-<< matrix.os >>
      - browser_test:
          name: browser_test-linux
          requires:
            - build_install_test-linux
      - browser_test:
          name: browser_test-macos
          requires:
            - build_install_test-macos
      - browser_test:
          name: browser_test-win
          requires:
            - build_install_test-win
