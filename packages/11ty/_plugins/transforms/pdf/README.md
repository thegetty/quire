## Transform to combine HTML output for PDF

The PDF module implements an [Eleventy `transform` function](https://www.11ty.dev/docs/config/#transforms) that prepares the static output for input to the [`Paged.js`](https://pagedjs.org) library. The HTML output from static rendering is output to a combined HTML file that is the input to the [`Paged.js`](https://pagedjs.org) commands.

## Reading the HTML output files

The transform function is called for each template, with the output HTML and output path as arguments, at the end of the build step before the individual page content is written to file on disk.

### Selecting the content

The transfrom uses the [`JSDOM` library](https://github.com/jsdom/jsdom) to create an HTML `document` from the rendered output and `querySelect` a `section` element that contains the content. The `section` containing the content is selected by the `data-ouput-path` attribute applied to the wrapping `section` element rendered by the [`base.11ty.js` layout](../_layouts/base.11ty.js).

Below is simplified example of the `content` argument passed to the transform function:

```HTML
<!DOCTYPE html>
<html>
  <head>
    <!-- omitted -->
  </head>
  <body>
    <header>
      <!-- omitted -->
    </header>
    <main>
      <nav>
        <!-- omitted -->
      </nav>
      <section data-output-path="example/page.html">
        <p>This is the combined output of the `content` directory template file and the applied layouts.</p>
      </section>
    </main>
    <footer>
      <!-- omitted -->
    </footer>
  </body>
</html>
```

## Writing the transformed output

For each file output by the build process a `<section>` element is written to the combined output file. Note that "templates are rendered in the order generated by the dependency graph" (see [Eleventy Order of Operation](https://www.11ty.dev/docs/advanced-order/#order-of-operations)), which
prevents the transform function from simply appending the HTML fragments to the combined output file. To ensure that content in the combined output file appears in the correct order the transform function must be aware of the computed page order.

### Insertion algorithm

A map of all `<section>` elements written to output file is maintained to allow quick lookup of parent and sibling sections.

For each `<section>` content fragment to be written to the output file its location is determined by comparing the value of its `data-ouput-path` with the computed page order and the current map of `<section>` elements written.

#### Computing content order

After selecting the `<section>` element by its `data-ouput-path` attribute the location of that content in looked up in the computed page order and the nearest siblings and ancestors is then found in the array of `<section>` elements already written to the combined output file.

#### Inserting the content

The `<section>` content fragment is written to the combined output file by calling `insertBefore` or `insertAfter` on the nearest ancestor `<section>` element.


## Exclude/include content from the publication PDF

### Pages [for editors]

Use the front-matter `outputs` key to define outputs, for example:

```yaml
outputs:
  - html
```

### Components [for developers]

*Not yet implemented*

Possible solutions:

- Add css classes for print only output. This is less ideal as the markup will be sent to Paged.js for parsing.

```html
<canvas-panel />
```

`print.css` (assuming Paged.js loads only the print css)
```css
@media(print) {
  canvas-panel {
    display: none;
  }
}
```
*this is likely to cause errors for ePub*

- Remove `<video>`, `<web-components>`, et all using either the Eleventy transform or Paged.js `afterParse` hook.

  Ideally Paged.js can force using the fallback for videos (@todo, implement fallback for Quire video component), is possible with Youtube embeds?

- Render both markup for *both* web and print, then remove any markup not for current output during Eleventy transform or from an after build hook.

```html
<!-- markup for screen -->
<canvas-panel data-outputs="html" />
<!-- markup for print -->
<img data-outputs="pdf, ebub" />
```

- Render the static alternative and save the output as a string. When parsing the site output for tranform lookup and replace the component markup in `pdf.html` with the static version.

- Register an alternate component render function that will be called from the PDF transform; we may not have access to the component data at this point.

Can an Eleventy plugin add a `registerTransform` function to Eleventy?

`web-components/canvas-panel.js`
```javascript
eleventyConfig.registerTransform(id, transform)
```

```javascript
{
  'id1': (args) => { return '' }
  'id2': '<img src="" alt="" />'
}
```

```javascript
{
  'id1': {
    selector: 'data-gradoo'
    render: (args) => return '<em>GRADOO</em>'
  },
  'id2': {
    selector: 'data-gradoo'
    render: '<em>GRADOO</em>'
  }
}
```


```javascript
transforms: {
  'output-path-a': {
    epub: [
      {
        args: [],
        selector: 'data-gradoo'
        render: '<em>GRADOO</em>'
      }
    ],
    html: [
      {
        args: ['GRADOO'],
        selector: 'data-gradoo'
        render: (args) => return '<em>GRADOO</em>'
      },
    ],
    pdf: [
      {
        args: [],
        selector: 'data-gradoo'
        render: '<em>GRADOO</em>'
      }
    ]
  }
}
```


## TODO

- Remove redundant element `id` attributes during transform

- Correct output path of `_assets` and remove chunk hash from asset filename

- Remove gremlins around `<svg>` output

- Trasnform `scss` to `css` or omit `application.scss` and ensure a separate non-interactive style sheet?

- Investigate refactoring `layouts` to render template content in a `<main>` element, which will then be the content appended to `pdf.html` (this will help make the HTML more semenatic)

- Find missing book pages from previous version of Quire and identify implementation tasks: blank page, cover, front-matter

- Render page title and section title when tranforming page content for pdf.html

- See [Paged.js _Introduction to Paged Media_](https://pagedjs.org/documentation/5-web-design-for-print/) for how to get page number references, `print.scss` line 63.

## Open Questions

- _What markup is required to correctly render sections, section headings (title, subtitle, et cetera)?_

`input`
```html
<main class="quire-essay">
  ...
</main>
```

`output` written to `pdf.html`
```html
<section class="quire-essay">
  ...
</section>
```

- _What is the PDF standard for TOC markup?_

  We will do what we want though use the [something like this basic pattern](https://www.w3.org/TR/epub-33/#example-basic-patterns-of-a-navigation-element) which uses `<nav><ol>...</ol></nav>`

- _Can we pass the TOC JSON to the Paged.js API to use as the PDF outline?_

  PrinceXML can be passed a CSS selector though currently used the `h1` tags to generate the PDF outline.

  Paged.js can take an element list (default `h1`â€“`h4`) to generate the outline.

  We do not need to do this, perhaps a future feature.

- _How can we access the PDF page numbering?_
  _For example, were we to render the TOC Grid how might we get the PDF page number for each section so that it can be rendered below the section image?_

  See [Paged.js _Introduction to Paged Media_]( https://pagedjs.org/documentation/5-web-design-for-print/)


## Paged Media


## CSS Animations

All CSS animations must be wrapped in a `@media(screen)` tag


